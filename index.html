<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>æ¬¢å–œæ‰¹é‡æœºå™¨äºº V2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- æœ¬åœ° ethers.jsï¼ˆç¡®ä¿åŒç›®å½•ä¸‹æœ‰ ethers.min.jsï¼‰ -->
  <script src="./ethers.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang SC", "Microsoft YaHei", sans-serif;
      background: radial-gradient(circle at top, #1f2937 0, #020617 55%, #000 100%);
      color: #e5e7eb;
    }
    a { color: #38bdf8; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }
    header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 24px;
    }
    .title {
      font-size: 24px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .subtitle {
      font-size: 13px;
      color: #9ca3af;
    }
    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.7);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn {
      border-radius: 999px;
      padding: 8px 18px;
      background: linear-gradient(to right, #22c55e, #16a34a);
      color: white;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 10px 25px rgba(34,197,94,0.35);
    }
    .btn:hover { filter: brightness(1.05); }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
    }
    .btn-secondary {
      border-radius: 999px;
      padding: 6px 14px;
      background: rgba(31,41,55,0.9);
      color: #e5e7eb;
      border: 1px solid rgba(75,85,99,0.8);
      cursor: pointer;
      font-size: 13px;
    }
    .btn-secondary:hover { filter: brightness(1.08); }
    .status-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 12px;
      margin-bottom: 20px;
    }
    .status-pill {
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(15,23,42,0.85);
      border: 1px solid rgba(55,65,81,0.8);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .status-pill span.label {
      color: #9ca3af;
    }
    main {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.1fr);
      gap: 20px;
    }
    @media (max-width: 900px) {
      main { grid-template-columns: minmax(0,1fr); }
    }
    h2 {
      font-size: 18px;
      margin: 12px 0 12px;
    }
    h3 {
      font-size: 15px;
      margin: 8px 0 8px;
    }
    .card {
      background: rgba(15,23,42,0.92);
      border-radius: 18px;
      padding: 16px 16px 18px;
      border: 1px solid rgba(75,85,99,0.7);
      box-shadow: 0 18px 40px rgba(15,23,42,0.9);
      margin-bottom: 14px;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 8px;
    }
    .badge {
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(148,163,184,0.5);
      color: #9ca3af;
    }
    .field {
      margin-bottom: 10px;
    }
    .field label {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-bottom: 4px;
      color: #d1d5db;
    }
    .field small {
      color: #9ca3af;
      font-size: 11px;
    }
    input[type="text"],
    input[type="number"],
    textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(55,65,81,0.9);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      font-size: 13px;
      resize: vertical;
    }
    textarea {
      min-height: 76px;
      max-height: 180px;
    }
    input:focus,
    textarea:focus {
      outline: none;
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56,189,248,0.3);
    }
    .card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 6px;
      font-size: 11px;
      color: #9ca3af;
      gap: 8px;
      flex-wrap: wrap;
    }
    .card-footer .gas-hint {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .hint {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 8px;
      line-height: 1.5;
    }
    .error {
      color: #fca5a5;
      font-size: 12px;
      margin-top: 4px;
      white-space: pre-wrap;
    }
    .success {
      color: #4ade80;
      font-size: 12px;
      margin-top: 4px;
      white-space: pre-wrap;
    }
    code {
      font-size: 11px;
      background: rgba(15,23,42,0.9);
      border-radius: 6px;
      padding: 2px 6px;
    }
    .section-divider {
      margin-top: 12px;
      margin-bottom: 4px;
      font-size: 13px;
      font-weight: 600;
      color: #9ca3af;
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div>
      <div class="title">
        ğŸ§§ æ¬¢å–œæ‰¹é‡æœºå™¨äºº V2
        <span class="pill">BNB Chain Â· æ‰¹é‡ä¹°å…¥ & ç©ºæŠ•åŠ©æ‰‹</span>
      </div>
      <div class="subtitle">
        è¿æ¥ MetaMask åï¼Œé€‰æ‹©æ”¯ä»˜æ–¹å¼å’Œæ¨¡å¼ï¼Œä¸€æ¬¡æ€§ç»™å¤šåœ°å€ä¹°å…¥ç›®æ ‡ä»£å¸ / ç©ºæŠ•ã€‚ä»…åˆçº¦ Owner å¯æ“ä½œã€‚
      </div>
    </div>
    <div>
      <button id="connectBtn" class="btn">
        <span>è¿æ¥ MetaMask</span>
      </button>
    </div>
  </header>

  <div class="status-bar">
    <div class="status-pill" id="addrStatus">
      <span class="label">é’±åŒ…åœ°å€</span>
      <span id="walletAddress">æœªè¿æ¥</span>
    </div>
    <div class="status-pill">
      <span class="label">ç½‘ç»œ</span>
      <span id="networkName">-</span>
    </div>
    <div class="status-pill">
      <span class="label">åˆçº¦</span>
      <span>
        <a href="https://bscscan.com/address/0xe39433810EC31f6F7d189079A1F334c4A08E9530#writeContract" target="_blank">
          0xe394...E9530
        </a>
      </span>
    </div>
    <div class="status-pill" id="ownerStatus">
      <span class="label">æƒé™</span>
      <span id="ownerFlag">æœªçŸ¥</span>
    </div>
    <div class="status-pill">
      <span class="label">è¿è¡ŒçŠ¶æ€</span>
      <span id="pausedFlag">-</span>
    </div>
    <div class="status-pill">
      <span class="label">åˆçº¦ BNB ä½™é¢</span>
      <span id="contractBNBBalance">-</span>
    </div>
  </div>

  <main>
    <!-- å·¦ä¾§ï¼šæ™®é€šè´­ä¹° -->
    <section>
      <h2>æ™®é€šè´­ä¹°æ¨¡å¼</h2>
      <p class="hint">
        å›ºå®šæ¯ä¸ªåœ°å€èŠ±å¤šå°‘é’±ï¼ŒæŒ‰é¡ºåºä¸ºå¤šä¸ªåœ°å€ä¹°å…¥ç›®æ ‡ä»£å¸ã€‚<br>
        æ‰€æœ‰é‡‘é¢éƒ½ç”¨æ­£å¸¸å†™æ³•ï¼Œä¾‹å¦‚ <code>0.01</code>ã€<code>100</code>ï¼Œå‰ç«¯è‡ªåŠ¨åŠ  0ã€‚
      </p>

      <!-- BNB æ™®é€šè´­ä¹° -->
      <div class="card">
        <div class="card-header">
          <h3>ç”¨ BNB æ™®é€šè´­ä¹°</h3>
          <span class="badge">æ”¯ä»˜æ–¹å¼ï¼šåŸç”Ÿ BNB</span>
        </div>
        <form id="form-bnb-normal">
          <div class="field">
            <label>
              <span>ç›®æ ‡ä»£å¸åœ°å€ (tokenToBuy)</span>
            </label>
            <input type="text" id="bnbNormal-token" placeholder="ä¾‹å¦‚ï¼š0x... ç›®æ ‡ä»£å¸åˆçº¦åœ°å€" required />
          </div>

          <div class="field">
            <label>
              <span>æ¯ä¸ªåœ°å€èŠ±è´¹ BNB æ•°é‡</span>
              <small>è‡ªåŠ¨è½¬æ¢ä¸º weiï¼Œæ— éœ€æ‰‹åŠ¨åŠ  18 ä¸ª 0</small>
            </label>
            <input type="number" step="0.000000000000000001" min="0" id="bnbNormal-per"
                   placeholder="ä¾‹å¦‚ï¼š0.01" required />
          </div>

          <div class="field">
            <label>
              <span>æ”¶å¸åœ°å€åˆ—è¡¨ (ä¸€è¡Œä¸€ä¸ªåœ°å€)</span>
              <small>å»ºè®®å…ˆç”¨æå°é‡‘é¢æµ‹è¯•</small>
            </label>
            <textarea id="bnbNormal-recipients"
                      placeholder="0xåœ°å€1
0xåœ°å€2
0xåœ°å€3"></textarea>
          </div>

          <div id="bnbNormal-msg"></div>

          <div class="card-footer">
            <div class="gas-hint">
              ğŸ’¡ æ€» BNB = æ¯ä¸ªåœ°å€èŠ±è´¹ Ã— åœ°å€æ•°é‡ï¼ˆä»åˆçº¦ä½™é¢ä¸­æ‰£ï¼‰
            </div>
            <button type="submit" class="btn" id="bnbNormal-submit">å‘é€äº¤æ˜“</button>
          </div>
        </form>
      </div>

      <!-- é»˜è®¤æ”¯ä»˜ä»£å¸æ™®é€šè´­ä¹° -->
      <div class="card">
        <div class="card-header">
          <h3>ç”¨é»˜è®¤æ”¯ä»˜ä»£å¸æ™®é€šè´­ä¹°</h3>
          <span class="badge">æ”¯ä»˜æ–¹å¼ï¼špayTokenï¼ˆé»˜è®¤ USDTï¼‰</span>
        </div>
        <div class="hint">
          é»˜è®¤æ”¯ä»˜ä»£å¸å¯ä»¥åœ¨åˆçº¦é‡Œç”¨ <code>setPayToken</code> è°ƒæ•´ã€‚<br>
          ä½¿ç”¨å‰è¯·å…ˆæŠŠè¯¥ä»£å¸è½¬å…¥åˆçº¦åœ°å€ï¼Œå¹¶ç¡®ä¿å·²æˆæƒç»™è·¯ç”±ã€‚
        </div>
        <form id="form-pay-normal">
          <div class="field">
            <label>
              <span>ç›®æ ‡ä»£å¸åœ°å€ (tokenToBuy)</span>
            </label>
            <input type="text" id="payNormal-token" placeholder="0x... ç›®æ ‡ä»£å¸åˆçº¦åœ°å€" required />
          </div>

          <div class="field">
            <label>
              <span>æ¯ä¸ªåœ°å€èŠ±è´¹æ”¯ä»˜ä»£å¸æ•°é‡</span>
              <small>æŒ‰ payToken çš„ decimals è‡ªåŠ¨è½¬æ¢</small>
            </label>
            <input type="number" step="0.00000001" min="0" id="payNormal-per"
                   placeholder="ä¾‹å¦‚ï¼š100ï¼ˆä»£è¡¨ 100 USDTï¼‰" required />
          </div>

          <div class="field">
            <label>
              <span>æ”¶å¸åœ°å€åˆ—è¡¨ (ä¸€è¡Œä¸€ä¸ªåœ°å€)</span>
            </label>
            <textarea id="payNormal-recipients"
                      placeholder="0xåœ°å€1
0xåœ°å€2"></textarea>
          </div>

          <div id="payNormal-msg"></div>

          <div class="card-footer">
            <div class="gas-hint">
              ğŸ’¡ æ€»èŠ±è´¹ = æ¯ä¸ªåœ°å€é‡‘é¢ Ã— åœ°å€æ•°é‡ï¼ˆä»åˆçº¦æŒæœ‰çš„ payToken ä¸­æ‰£ï¼‰
            </div>
            <button type="submit" class="btn" id="payNormal-submit">å‘é€äº¤æ˜“</button>
          </div>
        </form>
      </div>

      <!-- è‡ªå®šä¹‰æ”¯ä»˜ä»£å¸æ™®é€šè´­ä¹° -->
      <div class="card">
        <div class="card-header">
          <h3>ç”¨è‡ªå®šä¹‰ä»£å¸æ™®é€šè´­ä¹°</h3>
          <span class="badge">æ”¯ä»˜æ–¹å¼ï¼šä»»æ„ ERC20 ä»£å¸</span>
        </div>
        <div class="hint">
          å°†ä½ æƒ³ç”¨çš„æ”¯ä»˜ä»£å¸ï¼ˆå¦‚ USD1ã€æŸ Meme å¸ï¼‰è½¬å…¥åˆçº¦åœ°å€ï¼Œç„¶ååœ¨ä¸‹æ–¹è¾“å…¥å…¶åˆçº¦åœ°å€ã€‚
        </div>
        <form id="form-custom-normal">
          <div class="field">
            <label>
              <span>æ”¯ä»˜ä»£å¸åœ°å€ (payTokenAddr)</span>
            </label>
            <input type="text" id="customNormal-payToken" placeholder="0x... æ”¯ä»˜ä»£å¸åˆçº¦åœ°å€" required />
          </div>

          <div class="field">
            <label>
              <span>ç›®æ ‡ä»£å¸åœ°å€ (tokenToBuy)</span>
            </label>
            <input type="text" id="customNormal-token" placeholder="0x... ç›®æ ‡ä»£å¸åˆçº¦åœ°å€" required />
          </div>

          <div class="field">
            <label>
              <span>æ¯ä¸ªåœ°å€èŠ±è´¹æ”¯ä»˜ä»£å¸æ•°é‡</span>
              <small>æŒ‰æ”¯ä»˜ä»£å¸ decimals è‡ªåŠ¨è½¬æ¢</small>
            </label>
            <input type="number" step="0.00000001" min="0" id="customNormal-per"
                   placeholder="ä¾‹å¦‚ï¼š50" required />
          </div>

          <div class="field">
            <label>
              <span>æ”¶å¸åœ°å€åˆ—è¡¨ (ä¸€è¡Œä¸€ä¸ªåœ°å€)</span>
            </label>
            <textarea id="customNormal-recipients"
                      placeholder="0xåœ°å€1
0xåœ°å€2"></textarea>
          </div>

          <div id="customNormal-msg"></div>

          <div class="card-footer">
            <div class="gas-hint">
              ğŸ’¡ å¦‚é‡æˆæƒä¸è¶³ï¼Œå¯åœ¨åˆçº¦é¡µå…ˆè°ƒç”¨ <code>forceApprove</code>ã€‚
            </div>
            <button type="submit" class="btn" id="customNormal-submit">å‘é€äº¤æ˜“</button>
          </div>
        </form>
      </div>
    </section>

    <!-- å³ä¾§ï¼šé™é¢è´­ä¹° + ç®¡ç†åŠŸèƒ½ -->
    <section>
      <h2>é™é¢è´­ä¹°æ¨¡å¼</h2>
      <p class="hint">
        æ¯ä¸ªåœ°å€è®¾ç½®ã€Œæœ€å¤§èŠ±è´¹é‡‘é¢ + ç›®æ ‡ä¹°å…¥æ•°é‡ã€ã€‚<br>
        è‹¥é‡‘é¢è¶³å¤Ÿåˆ™æŒ‰ç…§ç›®æ ‡ä¹°å…¥ï¼Œé‡‘é¢ä¸è¶³åˆ™ç”¨æœ€å¤§å¯ç”¨é‡‘é¢å…¨åŠ›ä¹°ã€‚
      </p>

      <!-- BNB é™é¢è´­ä¹° -->
      <div class="card">
        <div class="card-header">
          <h3>BNB é™é¢è´­ä¹°</h3>
          <span class="badge">æ”¯ä»˜æ–¹å¼ï¼šBNB Â· æ¨¡å¼ï¼šé™é¢</span>
        </div>
        <form id="form-bnb-limited">
          <div class="field">
            <label>
              <span>ç›®æ ‡ä»£å¸åœ°å€ (tokenToBuy)</span>
            </label>
            <input type="text" id="bnbLimited-token" placeholder="0x... ç›®æ ‡ä»£å¸åˆçº¦åœ°å€" required />
          </div>

          <div class="field">
            <label>
              <span>åœ°å€é…ç½®åˆ—è¡¨</span>
              <small>ä¸€è¡Œä¸€ä¸ªï¼šåœ°å€, æœ€å¤§èŠ±è´¹BNB, ç›®æ ‡ä¹°å…¥æ•°é‡ï¼ˆä¸ªï¼‰</small>
            </label>
            <textarea id="bnbLimited-params"
                      placeholder="0xåœ°å€1, 0.05, 1000
0xåœ°å€2, 0.02, 500
0xåœ°å€3, 0.01, 0  ï¼ˆç›®æ ‡å¡« 0 è¡¨ç¤ºå…¨åŠ›ä¹°ï¼‰"></textarea>
          </div>

          <div id="bnbLimited-msg"></div>

          <div class="card-footer">
            <div class="gas-hint">
              ğŸ’¡ æœ¬æ¬¡äº¤æ˜“é™„å¸¦çš„ BNB å»ºè®® â‰¥ æ‰€æœ‰â€œæœ€å¤§èŠ±è´¹BNBâ€ä¹‹å’Œ
            </div>
            <button type="submit" class="btn" id="bnbLimited-submit">å‘é€äº¤æ˜“</button>
          </div>
        </form>
      </div>

      <!-- é»˜è®¤æ”¯ä»˜ä»£å¸é™é¢è´­ä¹° -->
      <div class="card">
        <div class="card-header">
          <h3>é»˜è®¤æ”¯ä»˜ä»£å¸é™é¢è´­ä¹°</h3>
          <span class="badge">æ”¯ä»˜æ–¹å¼ï¼špayToken Â· æ¨¡å¼ï¼šé™é¢</span>
        </div>
        <form id="form-pay-limited">
          <div class="field">
            <label>
              <span>ç›®æ ‡ä»£å¸åœ°å€ (tokenToBuy)</span>
            </label>
            <input type="text" id="payLimited-token" placeholder="0x... ç›®æ ‡ä»£å¸åˆçº¦åœ°å€" required />
          </div>

          <div class="field">
            <label>
              <span>åœ°å€é…ç½®åˆ—è¡¨</span>
              <small>ä¸€è¡Œä¸€ä¸ªï¼šåœ°å€, æœ€å¤§èŠ±è´¹æ”¯ä»˜å¸, ç›®æ ‡ä¹°å…¥æ•°é‡</small>
            </label>
            <textarea id="payLimited-params"
                      placeholder="0xåœ°å€1, 100, 1000
0xåœ°å€2, 50, 500"></textarea>
          </div>

          <div id="payLimited-msg"></div>

          <div class="card-footer">
            <div class="gas-hint">
              ğŸ’¡ æ€»æ¶ˆè€—ä»åˆçº¦æŒæœ‰çš„ payToken ä¸­æ‰£é™¤
            </div>
            <button type="submit" class="btn" id="payLimited-submit">å‘é€äº¤æ˜“</button>
          </div>
        </form>
      </div>

      <!-- è‡ªå®šä¹‰ä»£å¸é™é¢è´­ä¹°ï¼ˆå¦‚æœåˆçº¦ä¸­å·²åŠ å…¥ï¼‰ -->
      <div class="card">
        <div class="card-header">
          <h3>è‡ªå®šä¹‰ä»£å¸é™é¢è´­ä¹°</h3>
          <span class="badge">æ”¯ä»˜æ–¹å¼ï¼šè‡ªå®šä¹‰ Token Â· æ¨¡å¼ï¼šé™é¢</span>
        </div>
        <form id="form-custom-limited">
          <div class="field">
            <label>
              <span>æ”¯ä»˜ä»£å¸åœ°å€ (payTokenAddr)</span>
            </label>
            <input type="text" id="customLimited-payToken" placeholder="0x... æ”¯ä»˜ä»£å¸åˆçº¦åœ°å€" required />
          </div>

          <div class="field">
            <label>
              <span>ç›®æ ‡ä»£å¸åœ°å€ (tokenToBuy)</span>
            </label>
            <input type="text" id="customLimited-token" placeholder="0x... ç›®æ ‡ä»£å¸åˆçº¦åœ°å€" required />
          </div>

          <div class="field">
            <label>
              <span>åœ°å€é…ç½®åˆ—è¡¨</span>
              <small>ä¸€è¡Œä¸€ä¸ªï¼šåœ°å€, æœ€å¤§èŠ±è´¹æ”¯ä»˜å¸, ç›®æ ‡ä¹°å…¥æ•°é‡</small>
            </label>
            <textarea id="customLimited-params"
                      placeholder="0xåœ°å€1, 100, 1000
0xåœ°å€2, 50, 500"></textarea>
          </div>

          <div id="customLimited-msg"></div>

          <div class="card-footer">
            <div class="gas-hint">
              ğŸ’¡ å¦‚é‡æˆæƒä¸è¶³ï¼Œå¯åœ¨åˆçº¦é¡µé¢å¯¹è¯¥ä»£å¸å…ˆè°ƒç”¨ forceApprove
            </div>
            <button type="submit" class="btn" id="customLimited-submit">å‘é€äº¤æ˜“</button>
          </div>
        </form>
      </div>

      <!-- ç®¡ç†ä¸å·¥å…· -->
      <h2>ç®¡ç†ä¸å·¥å…·</h2>

      <!-- å®‰å…¨å¼€å…³ -->
      <div class="card">
        <div class="card-header">
          <h3>å®‰å…¨å¼€å…³ï¼ˆæš‚åœ / æ¢å¤ï¼‰</h3>
          <span class="badge">ä»… Owner å¯æ“ä½œ</span>
        </div>
        <div class="hint" id="pausedStateText">å½“å‰çŠ¶æ€ï¼šæœªçŸ¥</div>
        <div id="pause-msg"></div>
        <div class="card-footer">
          <div class="gas-hint">
            âš ï¸ æš‚åœåï¼Œæ‰€æœ‰ä¹°å…¥ / ç©ºæŠ•å‡½æ•°éƒ½ä¼šæ‹’ç»æ‰§è¡Œï¼Œä½†ä¾ç„¶å¯ä»¥æç°ã€‚
          </div>
          <div style="display:flex; gap:6px; flex-wrap:wrap;">
            <button class="btn-secondary" id="pause-btn">æš‚åœæ‰€æœ‰è´­ä¹°</button>
            <button class="btn-secondary" id="unpause-btn">æ¢å¤è´­ä¹°</button>
          </div>
        </div>
      </div>

      <!-- æ‰¹é‡ç©ºæŠ• BNB -->
      <div class="card">
        <div class="card-header">
          <h3>æ‰¹é‡ç©ºæŠ• BNB</h3>
          <span class="badge">ä»åˆçº¦ä½™é¢ä¸­å‘æ”¾</span>
        </div>
        <div class="hint">
          æŒ‰å›ºå®š BNB é‡‘é¢ç©ºæŠ•ç»™å¤šä¸ªåœ°å€ï¼Œé‡‘é¢ä»åˆçº¦ BNB ä½™é¢ä¸­æ‰£é™¤ã€‚
        </div>
        <form id="form-airdrop-bnb">
          <div class="field">
            <label>
              <span>æ¯ä¸ªåœ°å€ç©ºæŠ• BNB æ•°é‡</span>
              <small>ä¾‹å¦‚ï¼š0.005</small>
            </label>
            <input type="number" step="0.000000000000000001" min="0" id="airdrop-bnb-per"
                   placeholder="ä¾‹å¦‚ï¼š0.005" required />
          </div>
          <div class="field">
            <label>
              <span>åœ°å€åˆ—è¡¨ï¼ˆä¸€è¡Œä¸€ä¸ªåœ°å€ï¼‰</span>
            </label>
            <textarea id="airdrop-bnb-recipients"
                      placeholder="0xåœ°å€1
0xåœ°å€2"></textarea>
          </div>

          <div id="airdrop-bnb-msg"></div>

          <div class="card-footer">
            <div class="gas-hint">
              ğŸ’¡ æ€»æ¶ˆè€— = æ¯ä¸ªåœ°å€ BNB Ã— åœ°å€æ•°é‡
            </div>
            <button type="submit" class="btn" id="airdrop-bnb-submit">æ‰§è¡Œç©ºæŠ•</button>
          </div>
        </form>
      </div>

      <!-- æ‰¹é‡ç©ºæŠ• Tokenï¼ˆç­‰é¢ï¼‰ + æç° -->
      <div class="card">
        <div class="card-header">
          <h3>æ‰¹é‡ç©ºæŠ• Token & æç°</h3>
          <span class="badge">Token ç©ºæŠ• / æç°å·¥å…·</span>
        </div>

        <div class="section-divider">æ‰¹é‡ç©ºæŠ• Tokenï¼ˆç­‰é¢ï¼‰</div>
        <div class="hint">
          å°†æŒ‡å®š Token ç­‰é¢ç©ºæŠ•ç»™å¤šä¸ªåœ°å€ã€‚Token éœ€æå‰è½¬å…¥åˆçº¦ã€‚
        </div>
        <form id="form-airdrop-token">
          <div class="field">
            <label>
              <span>Token åœ°å€</span>
            </label>
            <input type="text" id="airdrop-token-token" placeholder="0x... Token åˆçº¦åœ°å€" />
          </div>
          <div class="field">
            <label>
              <span>æ¯ä¸ªåœ°å€ç©ºæŠ•æ•°é‡</span>
              <small>æŒ‰è¯¥ Token çš„ decimals è‡ªåŠ¨æ¢ç®—</small>
            </label>
            <input type="number" step="0.00000001" min="0" id="airdrop-token-per"
                   placeholder="ä¾‹å¦‚ï¼š100ï¼ˆä»£è¡¨ 100 ä¸ªï¼‰" />
          </div>
          <div class="field">
            <label>
              <span>åœ°å€åˆ—è¡¨ï¼ˆä¸€è¡Œä¸€ä¸ªåœ°å€ï¼‰</span>
            </label>
            <textarea id="airdrop-token-recipients"
                      placeholder="0xåœ°å€1
0xåœ°å€2"></textarea>
          </div>
          <div id="airdrop-token-msg"></div>

          <div class="card-footer">
            <div class="gas-hint">
              ğŸ’¡ æ€»æ¶ˆè€— = æ¯ä¸ªåœ°å€æ•°é‡ Ã— åœ°å€æ•°ï¼Œä»åˆçº¦æŒæœ‰ Token ä¸­æ‰£ã€‚
            </div>
            <button type="submit" class="btn" id="airdrop-token-submit">æ‰§è¡Œç©ºæŠ•</button>
          </div>
        </form>

        <div class="section-divider">æç° BNB / Token</div>
        <div class="hint">
          å½“å‰åˆçº¦ BNB ä½™é¢ï¼š<span id="contractBNBBalance2">-</span>
        </div>
        <form id="form-withdraw-bnb">
          <div class="field">
            <label>
              <span>æå– BNB åˆ°åœ°å€</span>
            </label>
            <input type="text" id="withdraw-bnb-to" placeholder="0x... æ¥æ”¶åœ°å€" />
          </div>
          <div class="field">
            <label>
              <span>æå– BNB æ•°é‡</span>
              <small>å¦‚æœå¤§äºä½™é¢ï¼Œåˆçº¦ä¼šå…¨éƒ¨æèµ°</small>
            </label>
            <input type="number" step="0.000000000000000001" min="0" id="withdraw-bnb-amount"
                   placeholder="ä¾‹å¦‚ï¼š0.1" />
          </div>
        </form>

        <form id="form-withdraw-token">
          <div class="field">
            <label>
              <span>Token åœ°å€</span>
            </label>
            <input type="text" id="withdraw-token-token" placeholder="0x... Token åˆçº¦åœ°å€" />
          </div>
          <div class="field">
            <label>
              <span>æå–åˆ°åœ°å€</span>
            </label>
            <input type="text" id="withdraw-token-to" placeholder="0x... æ¥æ”¶åœ°å€" />
          </div>
          <div class="field">
            <label>
              <span>æå– Token æ•°é‡</span>
              <small>æ­£å¸¸å†™æ•°é‡ï¼ˆä¾‹å¦‚ï¼š100ï¼‰</small>
            </label>
            <input type="number" step="0.00000001" min="0" id="withdraw-token-amount"
                   placeholder="ä¾‹å¦‚ï¼š100" />
          </div>
        </form>

        <div id="withdraw-msg"></div>

        <div class="card-footer">
          <div class="gas-hint">
            ğŸ’¡ å»ºè®®å…ˆç”¨ã€ŒæŸ¥è¯¢ä½™é¢ã€ç¡®è®¤åˆçº¦æŒæœ‰çš„ Token æ•°é‡ã€‚
          </div>
          <div style="display:flex; gap:6px; flex-wrap:wrap;">
            <button class="btn-secondary" id="withdraw-bnb-submit">æå– BNB</button>
            <button class="btn-secondary" id="withdraw-token-check">æŸ¥è¯¢ Token ä½™é¢</button>
            <button class="btn-secondary" id="withdraw-token-submit">æå– Token</button>
          </div>
        </div>
      </div>

    </section>
  </main>
</div>

<script>
  // ===== åŸºæœ¬é…ç½® =====
  const CONTRACT_ADDRESS = "0xe39433810EC31f6F7d189079A1F334c4A08E9530";

  const CONTRACT_ABI = [
    "function owner() view returns (address)",
    "function payToken() view returns (address)",
    "function paused() view returns (bool)",

    "function pause()",
    "function unpause()",

    "function buyWithBNB(address tokenToBuy, uint256 bnbPerAddress, address[] calldata recipients) payable",
    "function buyWithPayToken(address tokenToBuy, uint256 amountPerAddress, address[] calldata recipients)",
    "function buyWithCustomToken(address payTokenAddr, address tokenToBuy, uint256 amountPerAddress, address[] calldata recipients)",

    "function limitedBuyWithBNB(address tokenToBuy, (address recipient,uint256 maxPayAmount,uint256 targetBuyAmount)[] calldata params) payable",
    "function limitedBuyWithPayToken(address tokenToBuy, (address recipient,uint256 maxPayAmount,uint256 targetBuyAmount)[] calldata params)",
    "function limitedBuyWithCustomToken(address payTokenAddr, address tokenToBuy, (address recipient,uint256 maxPayAmount,uint256 targetBuyAmount)[] calldata params)",

    "function airdropBNB(uint256 amountPerAddress, address[] calldata recipients)",
    "function airdropTokenEqual(address token, uint256 amountPerAddress, address[] calldata recipients)",

    "function withdrawBNB(address to, uint256 amount)",
    "function withdrawToken(address token, address to, uint256 amount)"
  ];

  const ERC20_ABI = [
    "function decimals() view returns (uint8)",
    "function balanceOf(address account) view returns (uint256)"
  ];

  let provider;
  let signer;
  let contract;
  let currentAccount;
  let contractOwner;
  let currentNetwork;

  const connectBtn = document.getElementById("connectBtn");
  const walletAddressSpan = document.getElementById("walletAddress");
  const networkNameSpan = document.getElementById("networkName");
  const ownerFlagSpan = document.getElementById("ownerFlag");
  const pausedFlagSpan = document.getElementById("pausedFlag");
  const contractBNBBalanceSpan = document.getElementById("contractBNBBalance");
  const contractBNBBalanceSpan2 = document.getElementById("contractBNBBalance2");
  const pausedStateText = document.getElementById("pausedStateText");

  function shortAddr(addr) {
    if (!addr) return "-";
    return addr.slice(0, 6) + "..." + addr.slice(-4);
  }

  function setMessage(el, type, msg) {
    el.innerHTML = "";
    if (!msg) return;
    const div = document.createElement("div");
    div.className = type === "error" ? "error" : "success";
    div.textContent = msg;
    el.appendChild(div);
  }

  function parseAddressList(text) {
    return text
      .split(/\n|,/)
      .map(s => s.trim())
      .filter(s => s.length > 0);
  }

  function parseLimitedParams(text) {
    const lines = text.split(/\n+/);
    const rows = [];
    for (let line of lines) {
      if (!line.trim()) continue;
      const parts = line.split(",").map(p => p.trim()).filter(Boolean);
      if (parts.length < 3) {
        throw new Error("é™é¢é…ç½®è¡Œæ ¼å¼é”™è¯¯ï¼Œè¯·ä½¿ç”¨ï¼šåœ°å€, æœ€å¤§èŠ±è´¹, ç›®æ ‡æ•°é‡");
      }
      rows.push({
        addr: parts[0],
        maxPay: parts[1],
        target: parts[2]
      });
    }
    if (rows.length === 0) {
      throw new Error("è¯·è‡³å°‘å¡«å†™ä¸€è¡Œåœ°å€é…ç½®ã€‚");
    }
    return rows;
  }

  async function getTokenDecimals(tokenAddr) {
    const token = new ethers.Contract(tokenAddr, ERC20_ABI, provider);
    return await token.decimals();
  }

  async function getTokenBalance(tokenAddr) {
    const token = new ethers.Contract(tokenAddr, ERC20_ABI, provider);
    return await token.balanceOf(CONTRACT_ADDRESS);
  }

  async function refreshContractStatus() {
    if (!provider || !contract) return;
    try {
      const [network, ownerAddr, pausedVal, bnbBal] = await Promise.all([
        provider.getNetwork(),
        contract.owner(),
        contract.paused(),
        provider.getBalance(CONTRACT_ADDRESS)
      ]);
      currentNetwork = network;
      contractOwner = ownerAddr;

      networkNameSpan.textContent = network.name + " (" + network.chainId + ")";
      const isOwner =
        currentAccount &&
        contractOwner &&
        currentAccount.toLowerCase() === contractOwner.toLowerCase();

      ownerFlagSpan.textContent = isOwner
        ? "å½“å‰åœ°å€ä¸ºåˆçº¦ Owner"
        : "å½“å‰åœ°å€ä¸æ˜¯ Ownerï¼ˆæ— æ³•è°ƒç”¨ onlyOwner å‡½æ•°ï¼‰";
      ownerFlagSpan.style.color = isOwner ? "#4ade80" : "#f97316";

      pausedFlagSpan.textContent = pausedVal ? "å·²æš‚åœï¼ˆæ— æ³•ä¹°å…¥ / ç©ºæŠ•ï¼‰" : "è¿è¡Œä¸­";
      pausedFlagSpan.style.color = pausedVal ? "#f97316" : "#4ade80";
      pausedStateText.textContent = pausedVal ? "å½“å‰çŠ¶æ€ï¼šå·²æš‚åœ" : "å½“å‰çŠ¶æ€ï¼šè¿è¡Œä¸­";

      const bnbStr = ethers.utils.formatEther(bnbBal) + " BNB";
      contractBNBBalanceSpan.textContent = bnbStr;
      contractBNBBalanceSpan2.textContent = bnbStr;

      const pauseBtn = document.getElementById("pause-btn");
      const unpauseBtn = document.getElementById("unpause-btn");
      if (pauseBtn && unpauseBtn) {
        pauseBtn.disabled = !isOwner || pausedVal;
        unpauseBtn.disabled = !isOwner || !pausedVal;
      }
    } catch (err) {
      console.error("refreshContractStatus error:", err);
    }
  }

  async function connectWallet() {
    if (!window.ethereum) {
      alert("æœªæ£€æµ‹åˆ° MetaMaskï¼Œè¯·å…ˆå®‰è£…æµè§ˆå™¨é’±åŒ…ã€‚");
      return;
    }
    try {
      connectBtn.disabled = true;
      connectBtn.textContent = "è¿æ¥ä¸­...";

      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      currentAccount = await signer.getAddress();

      walletAddressSpan.textContent = shortAddr(currentAccount);

      currentNetwork = await provider.getNetwork();
      if (currentNetwork.chainId !== 56) {
        alert("å½“å‰ç½‘ç»œä¸æ˜¯ BNB Chain ä¸»ç½‘ï¼ˆchainId=56ï¼‰ã€‚è¯·åœ¨ MetaMask ä¸­åˆ‡æ¢åˆ° BNB Smart Chain Mainnetã€‚");
      }

      contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

      await refreshContractStatus();

      connectBtn.textContent = "å·²è¿æ¥";
    } catch (err) {
      console.error(err);
      alert("è¿æ¥å¤±è´¥ï¼š" + (err.message || err));
      connectBtn.textContent = "è¿æ¥ MetaMask";
    } finally {
      connectBtn.disabled = false;
    }
  }

  connectBtn.addEventListener("click", connectWallet);

  // ===== è¡¨å•ç»‘å®šï¼šæ™®é€š BNB è´­ä¹° =====
  document.getElementById("form-bnb-normal").addEventListener("submit", async (e) => {
    e.preventDefault();
    const msgBox = document.getElementById("bnbNormal-msg");
    setMessage(msgBox, "", "");
    try {
      if (!contract) throw new Error("è¯·å…ˆè¿æ¥ MetaMaskã€‚");
      const tokenToBuy = document.getElementById("bnbNormal-token").value.trim();
      const perStr = document.getElementById("bnbNormal-per").value.trim();
      const recText = document.getElementById("bnbNormal-recipients").value.trim();
      const recipients = parseAddressList(recText);

      if (!tokenToBuy || recipients.length === 0) {
        throw new Error("è¯·å¡«å†™ç›®æ ‡ä»£å¸åœ°å€å’Œè‡³å°‘ä¸€ä¸ªæ”¶å¸åœ°å€ã€‚");
      }

      const perBNB = ethers.utils.parseEther(perStr || "0");
      if (perBNB.lte(0)) throw new Error("æ¯ä¸ªåœ°å€èŠ±è´¹å¿…é¡»å¤§äº 0ã€‚");

      const totalBNB = perBNB.mul(recipients.length);

      setMessage(
        msgBox,
        "success",
        "å‡†å¤‡å‘é€äº¤æ˜“ï¼š\næ¯ä¸ªåœ°å€ " +
          perStr +
          " BNB Ã— " +
          recipients.length +
          " ä¸ªåœ°å€ = æ€»è®¡ " +
          ethers.utils.formatEther(totalBNB) +
          " BNB"
      );

      const tx = await contract.buyWithBNB(tokenToBuy, perBNB, recipients, {
        value: totalBNB
      });
      setMessage(msgBox, "success", "äº¤æ˜“å·²å‘é€ï¼Œç­‰å¾…ç¡®è®¤ä¸­...\nTX: " + tx.hash);
      await tx.wait();
      setMessage(msgBox, "success", "äº¤æ˜“å·²ç¡®è®¤ âœ…\nTX: " + tx.hash);
      await refreshContractStatus();
    } catch (err) {
      console.error(err);
      setMessage(msgBox, "error", "äº¤æ˜“å¤±è´¥ï¼š\n" + (err.data?.message || err.message || err));
    }
  });

  // ===== é»˜è®¤æ”¯ä»˜ä»£å¸æ™®é€šè´­ä¹° =====
  document.getElementById("form-pay-normal").addEventListener("submit", async (e) => {
    e.preventDefault();
    const msgBox = document.getElementById("payNormal-msg");
    setMessage(msgBox, "", "");
    try {
      if (!contract) throw new Error("è¯·å…ˆè¿æ¥ MetaMaskã€‚");

      const tokenToBuy = document.getElementById("payNormal-token").value.trim();
      const perStr = document.getElementById("payNormal-per").value.trim();
      const recText = document.getElementById("payNormal-recipients").value.trim();
      const recipients = parseAddressList(recText);
      if (!tokenToBuy || recipients.length === 0) {
        throw new Error("è¯·å¡«å†™ç›®æ ‡ä»£å¸åœ°å€å’Œè‡³å°‘ä¸€ä¸ªæ”¶å¸åœ°å€ã€‚");
      }

      const payTokenAddr = await contract.payToken();
      const decimals = await getTokenDecimals(payTokenAddr);
      const perAmount = ethers.utils.parseUnits(perStr || "0", decimals);
      if (perAmount.lte(0)) throw new Error("æ¯ä¸ªåœ°å€èŠ±è´¹å¿…é¡»å¤§äº 0ã€‚");

      setMessage(
        msgBox,
        "success",
        "å°†ä½¿ç”¨ payToken(" +
          shortAddr(payTokenAddr) +
          ")ï¼šæ¯ä¸ªåœ°å€ " +
          perStr +
          "ï¼Œå…± " +
          recipients.length +
          " ä¸ªåœ°å€ã€‚"
      );

      const tx = await contract.buyWithPayToken(tokenToBuy, perAmount, recipients);
      setMessage(msgBox, "success", "äº¤æ˜“å·²å‘é€ï¼Œç­‰å¾…ç¡®è®¤ä¸­...\nTX: " + tx.hash);
      await tx.wait();
      setMessage(msgBox, "success", "äº¤æ˜“å·²ç¡®è®¤ âœ…\nTX: " + tx.hash);
    } catch (err) {
      console.error(err);
      setMessage(msgBox, "error", "äº¤æ˜“å¤±è´¥ï¼š\n" + (err.data?.message || err.message || err));
    }
  });

  // ===== è‡ªå®šä¹‰æ”¯ä»˜ä»£å¸æ™®é€šè´­ä¹° =====
  document.getElementById("form-custom-normal").addEventListener("submit", async (e) => {
    e.preventDefault();
    const msgBox = document.getElementById("customNormal-msg");
    setMessage(msgBox, "", "");
    try {
      if (!contract) throw new Error("è¯·å…ˆè¿æ¥ MetaMaskã€‚");

      const payTokenAddr = document.getElementById("customNormal-payToken").value.trim();
      const tokenToBuy = document.getElementById("customNormal-token").value.trim();
      const perStr = document.getElementById("customNormal-per").value.trim();
      const recText = document.getElementById("customNormal-recipients").value.trim();
      const recipients = parseAddressList(recText);

      if (!payTokenAddr || !tokenToBuy || recipients.length === 0) {
        throw new Error("è¯·å¡«å†™æ”¯ä»˜ä»£å¸ã€ç›®æ ‡ä»£å¸å’Œæ”¶å¸åœ°å€ã€‚");
      }

      const decimals = await getTokenDecimals(payTokenAddr);
      const perAmount = ethers.utils.parseUnits(perStr || "0", decimals);
      if (perAmount.lte(0)) throw new Error("æ¯ä¸ªåœ°å€èŠ±è´¹å¿…é¡»å¤§äº 0ã€‚");

      setMessage(
        msgBox,
        "success",
        "ä½¿ç”¨ " +
          shortAddr(payTokenAddr) +
          "ï¼šæ¯ä¸ªåœ°å€ " +
          perStr +
          "ï¼Œå…± " +
          recipients.length +
          " ä¸ªåœ°å€ã€‚"
      );

      const tx = await contract.buyWithCustomToken(payTokenAddr, tokenToBuy, perAmount, recipients);
      setMessage(msgBox, "success", "äº¤æ˜“å·²å‘é€ï¼Œç­‰å¾…ç¡®è®¤ä¸­...\nTX: " + tx.hash);
      await tx.wait();
      setMessage(msgBox, "success", "äº¤æ˜“å·²ç¡®è®¤ âœ…\nTX: " + tx.hash);
    } catch (err) {
      console.error(err);
      setMessage(msgBox, "error", "äº¤æ˜“å¤±è´¥ï¼š\n" + (err.data?.message || err.message || err));
    }
  });

  // ===== BNB é™é¢è´­ä¹° =====
  document.getElementById("form-bnb-limited").addEventListener("submit", async (e) => {
    e.preventDefault();
    const msgBox = document.getElementById("bnbLimited-msg");
    setMessage(msgBox, "", "");
    try {
      if (!contract) throw new Error("è¯·å…ˆè¿æ¥ MetaMaskã€‚");
      const tokenToBuy = document.getElementById("bnbLimited-token").value.trim();
      const paramsText = document.getElementById("bnbLimited-params").value.trim();
      if (!tokenToBuy) throw new Error("è¯·å¡«å†™ç›®æ ‡ä»£å¸åœ°å€ã€‚");

      const rows = parseLimitedParams(paramsText);
      const tokenDecimals = await getTokenDecimals(tokenToBuy);

      const params = [];
      let totalMaxPay = ethers.BigNumber.from(0);
      rows.forEach((row) => {
        const recipient = row.addr;
        const maxPayWei = ethers.utils.parseEther(row.maxPay || "0");
        const targetAmt =
          row.target && row.target !== "0"
            ? ethers.utils.parseUnits(row.target, tokenDecimals)
            : ethers.BigNumber.from(0);

        if (maxPayWei.lte(0)) {
          throw new Error("æœ€å¤§èŠ±è´¹å¿…é¡»å¤§äº 0ï¼ˆåœ°å€ï¼š" + recipient + "ï¼‰ã€‚");
        }
        totalMaxPay = totalMaxPay.add(maxPayWei);
        params.push({
          recipient,
          maxPayAmount: maxPayWei,
          targetBuyAmount: targetAmt
        });
      });

      setMessage(
        msgBox,
        "success",
        "å‡†å¤‡å‘é€é™é¢è´­ä¹°ï¼šå…± " +
          params.length +
          " ä¸ªåœ°å€ï¼Œæ€»æœ€å¤§èŠ±è´¹çº¦ " +
          ethers.utils.formatEther(totalMaxPay) +
          " BNBã€‚"
      );

      const tx = await contract.limitedBuyWithBNB(tokenToBuy, params, { value: totalMaxPay });
      setMessage(msgBox, "success", "äº¤æ˜“å·²å‘é€ï¼Œç­‰å¾…ç¡®è®¤ä¸­...\nTX: " + tx.hash);
      await tx.wait();
      setMessage(msgBox, "success", "äº¤æ˜“å·²ç¡®è®¤ âœ…\nTX: " + tx.hash);
      await refreshContractStatus();
    } catch (err) {
      console.error(err);
      setMessage(msgBox, "error", "äº¤æ˜“å¤±è´¥ï¼š\n" + (err.data?.message || err.message || err));
    }
  });

  // ===== é»˜è®¤æ”¯ä»˜ä»£å¸ é™é¢è´­ä¹° =====
  document.getElementById("form-pay-limited").addEventListener("submit", async (e) => {
    e.preventDefault();
    const msgBox = document.getElementById("payLimited-msg");
    setMessage(msgBox, "", "");
    try {
      if (!contract) throw new Error("è¯·å…ˆè¿æ¥ MetaMaskã€‚");

      const tokenToBuy = document.getElementById("payLimited-token").value.trim();
      const paramsText = document.getElementById("payLimited-params").value.trim();
      if (!tokenToBuy) throw new Error("è¯·å¡«å†™ç›®æ ‡ä»£å¸åœ°å€ã€‚");

      const rows = parseLimitedParams(paramsText);
      const payTokenAddr = await contract.payToken();
      const payDecimals = await getTokenDecimals(payTokenAddr);
      const tokenDecimals = await getTokenDecimals(tokenToBuy);

      const params = [];
      rows.forEach((row) => {
        const recipient = row.addr;
        const maxPay = ethers.utils.parseUnits(row.maxPay || "0", payDecimals);
        const targetAmt =
          row.target && row.target !== "0"
            ? ethers.utils.parseUnits(row.target, tokenDecimals)
            : ethers.BigNumber.from(0);
        if (maxPay.lte(0)) {
          throw new Error("æœ€å¤§èŠ±è´¹å¿…é¡»å¤§äº 0ï¼ˆåœ°å€ï¼š" + recipient + "ï¼‰ã€‚");
        }
        params.push({
          recipient,
          maxPayAmount: maxPay,
          targetBuyAmount: targetAmt
        });
      });

      setMessage(
        msgBox,
        "success",
        "å°†ä½¿ç”¨ payToken(" +
          shortAddr(payTokenAddr) +
          ") è¿›è¡Œé™é¢è´­ä¹°ï¼Œåœ°å€æ•°ï¼š" +
          params.length
      );

      const tx = await contract.limitedBuyWithPayToken(tokenToBuy, params);
      setMessage(msgBox, "success", "äº¤æ˜“å·²å‘é€ï¼Œç­‰å¾…ç¡®è®¤ä¸­...\nTX: " + tx.hash);
      await tx.wait();
      setMessage(msgBox, "success", "äº¤æ˜“å·²ç¡®è®¤ âœ…\nTX: " + tx.hash);
    } catch (err) {
      console.error(err);
      setMessage(msgBox, "error", "äº¤æ˜“å¤±è´¥ï¼š\n" + (err.data?.message || err.message || err));
    }
  });

  // ===== è‡ªå®šä¹‰ä»£å¸ é™é¢è´­ä¹°ï¼ˆå¦‚æœåˆçº¦æ”¯æŒï¼‰ =====
  document.getElementById("form-custom-limited").addEventListener("submit", async (e) => {
    e.preventDefault();
    const msgBox = document.getElementById("customLimited-msg");
    setMessage(msgBox, "", "");
    try {
      if (!contract) throw new Error("è¯·å…ˆè¿æ¥ MetaMaskã€‚");

      const payTokenAddr = document.getElementById("customLimited-payToken").value.trim();
      const tokenToBuy = document.getElementById("customLimited-token").value.trim();
      const paramsText = document.getElementById("customLimited-params").value.trim();
      if (!payTokenAddr || !tokenToBuy) throw new Error("è¯·å¡«å†™æ”¯ä»˜ä»£å¸å’Œç›®æ ‡ä»£å¸åœ°å€ã€‚");

      const rows = parseLimitedParams(paramsText);
      const payDecimals = await getTokenDecimals(payTokenAddr);
      const tokenDecimals = await getTokenDecimals(tokenToBuy);

      const params = [];
      rows.forEach((row) => {
        const recipient = row.addr;
        const maxPay = ethers.utils.parseUnits(row.maxPay || "0", payDecimals);
        const targetAmt =
          row.target && row.target !== "0"
            ? ethers.utils.parseUnits(row.target, tokenDecimals)
            : ethers.BigNumber.from(0);
        if (maxPay.lte(0)) {
          throw new Error("æœ€å¤§èŠ±è´¹å¿…é¡»å¤§äº 0ï¼ˆåœ°å€ï¼š" + recipient + "ï¼‰ã€‚");
        }
        params.push({
          recipient,
          maxPayAmount: maxPay,
          targetBuyAmount: targetAmt
        });
      });

      setMessage(
        msgBox,
        "success",
        "ä½¿ç”¨è‡ªå®šä¹‰æ”¯ä»˜ä»£å¸ " +
          shortAddr(payTokenAddr) +
          " è¿›è¡Œé™é¢è´­ä¹°ï¼Œåœ°å€æ•°ï¼š" +
          params.length
      );

      const tx = await contract.limitedBuyWithCustomToken(payTokenAddr, tokenToBuy, params);
      setMessage(msgBox, "success", "äº¤æ˜“å·²å‘é€ï¼Œç­‰å¾…ç¡®è®¤ä¸­...\nTX: " + tx.hash);
      await tx.wait();
      setMessage(msgBox, "success", "äº¤æ˜“å·²ç¡®è®¤ âœ…\nTX: " + tx.hash);
    } catch (err) {
      console.error(err);
      setMessage(msgBox, "error", "äº¤æ˜“å¤±è´¥ï¼ˆå¦‚æœæŠ¥ function not foundï¼Œè¯´æ˜åˆçº¦æœªåŠ å…¥æ­¤å‡½æ•°ï¼‰ï¼š\n" + (err.data?.message || err.message || err));
    }
  });

  // ===== å®‰å…¨å¼€å…³ï¼šæš‚åœ / æ¢å¤ =====
  document.getElementById("pause-btn").addEventListener("click", async () => {
    const msgBox = document.getElementById("pause-msg");
    setMessage(msgBox, "", "");
    try {
      if (!contract) throw new Error("è¯·å…ˆè¿æ¥ MetaMaskã€‚");
      const tx = await contract.pause();
      setMessage(msgBox, "success", "æš‚åœäº¤æ˜“å·²å‘é€ï¼Œç­‰å¾…ç¡®è®¤ä¸­...\nTX: " + tx.hash);
      await tx.wait();
      setMessage(msgBox, "success", "å·²æš‚åœ âœ…\nTX: " + tx.hash);
      await refreshContractStatus();
    } catch (err) {
      console.error(err);
      setMessage(msgBox, "error", "æ“ä½œå¤±è´¥ï¼š\n" + (err.data?.message || err.message || err));
    }
  });

  document.getElementById("unpause-btn").addEventListener("click", async () => {
    const msgBox = document.getElementById("pause-msg");
    setMessage(msgBox, "", "");
    try {
      if (!contract) throw new Error("è¯·å…ˆè¿æ¥ MetaMaskã€‚");
      const tx = await contract.unpause();
      setMessage(msgBox, "success", "æ¢å¤äº¤æ˜“å·²å‘é€ï¼Œç­‰å¾…ç¡®è®¤ä¸­...\nTX: " + tx.hash);
      await tx.wait();
      setMessage(msgBox, "success", "å·²æ¢å¤ âœ…\nTX: " + tx.hash);
      await refreshContractStatus();
    } catch (err) {
      console.error(err);
      setMessage(msgBox, "error", "æ“ä½œå¤±è´¥ï¼š\n" + (err.data?.message || err.message || err));
    }
  });

  // ===== æ‰¹é‡ç©ºæŠ• BNB =====
  document.getElementById("form-airdrop-bnb").addEventListener("submit", async (e) => {
    e.preventDefault();
    const msgBox = document.getElementById("airdrop-bnb-msg");
    setMessage(msgBox, "", "");
    try {
      if (!contract) throw new Error("è¯·å…ˆè¿æ¥ MetaMaskã€‚");

      const perStr = document.getElementById("airdrop-bnb-per").value.trim();
      const recText = document.getElementById("airdrop-bnb-recipients").value.trim();
      const recipients = parseAddressList(recText);
      if (recipients.length === 0) throw new Error("è¯·è‡³å°‘å¡«å†™ä¸€ä¸ªåœ°å€ã€‚");

      const perBNB = ethers.utils.parseEther(perStr || "0");
      if (perBNB.lte(0)) throw new Error("æ¯ä¸ªåœ°å€ç©ºæŠ•æ•°é‡å¿…é¡»å¤§äº 0ã€‚");

      const totalBNB = perBNB.mul(recipients.length);
      setMessage(
        msgBox,
        "success",
        "å‡†å¤‡ç©ºæŠ•ï¼šæ¯ä¸ªåœ°å€ " +
          perStr +
          " BNB Ã— " +
          recipients.length +
          " ä¸ªåœ°å€ = æ€»è®¡ " +
          ethers.utils.formatEther(totalBNB) +
          " BNB"
      );

      const tx = await contract.airdropBNB(perBNB, recipients);
      setMessage(msgBox, "success", "ç©ºæŠ•äº¤æ˜“å·²å‘é€ï¼Œç­‰å¾…ç¡®è®¤ä¸­...\nTX: " + tx.hash);
      await tx.wait();
      setMessage(msgBox, "success", "ç©ºæŠ•å·²ç¡®è®¤ âœ…\nTX: " + tx.hash);
      await refreshContractStatus();
    } catch (err) {
      console.error(err);
      setMessage(msgBox, "error", "ç©ºæŠ•å¤±è´¥ï¼š\n" + (err.data?.message || err.message || err));
    }
  });

  // ===== æ‰¹é‡ç©ºæŠ• Tokenï¼ˆç­‰é¢ï¼‰ =====
  document.getElementById("form-airdrop-token").addEventListener("submit", async (e) => {
    e.preventDefault();
    const msgBox = document.getElementById("airdrop-token-msg");
    setMessage(msgBox, "", "");
    try {
      if (!contract) throw new Error("è¯·å…ˆè¿æ¥ MetaMaskã€‚");

      const tokenAddr = document.getElementById("airdrop-token-token").value.trim();
      const perStr = document.getElementById("airdrop-token-per").value.trim();
      const recText = document.getElementById("airdrop-token-recipients").value.trim();
      const recipients = parseAddressList(recText);

      if (!tokenAddr) throw new Error("è¯·å¡«å†™ Token åœ°å€ã€‚");
      if (recipients.length === 0) throw new Error("è¯·è‡³å°‘å¡«å†™ä¸€ä¸ªåœ°å€ã€‚");

      const decimals = await getTokenDecimals(tokenAddr);
      const perAmount = ethers.utils.parseUnits(perStr || "0", decimals);
      if (perAmount.lte(0)) throw new Error("æ¯ä¸ªåœ°å€ç©ºæŠ•æ•°é‡å¿…é¡»å¤§äº 0ã€‚");

      setMessage(
        msgBox,
        "success",
        "å‡†å¤‡ç©ºæŠ• Tokenï¼šæ¯ä¸ªåœ°å€ " +
          perStr +
          " Ã— " +
          recipients.length +
          " ä¸ªåœ°å€ã€‚"
      );

      const tx = await contract.airdropTokenEqual(tokenAddr, perAmount, recipients);
      setMessage(msgBox, "success", "ç©ºæŠ•äº¤æ˜“å·²å‘é€ï¼Œç­‰å¾…ç¡®è®¤ä¸­...\nTX: " + tx.hash);
      await tx.wait();
      setMessage(msgBox, "success", "ç©ºæŠ•å·²ç¡®è®¤ âœ…\nTX: " + tx.hash);
    } catch (err) {
      console.error(err);
      setMessage(msgBox, "error", "ç©ºæŠ•å¤±è´¥ï¼š\n" + (err.data?.message || err.message || err));
    }
  });

  // ===== æç° BNB =====
  document.getElementById("withdraw-bnb-submit").addEventListener("click", async () => {
    const msgBox = document.getElementById("withdraw-msg");
    setMessage(msgBox, "", "");
    try {
      if (!contract) throw new Error("è¯·å…ˆè¿æ¥ MetaMaskã€‚");
      const to = document.getElementById("withdraw-bnb-to").value.trim();
      const amountStr = document.getElementById("withdraw-bnb-amount").value.trim();
      if (!to) throw new Error("è¯·å¡«å†™æ¥æ”¶åœ°å€ã€‚");
      if (!amountStr) throw new Error("è¯·å¡«å†™æå– BNB æ•°é‡ã€‚");
      const amountWei = ethers.utils.parseEther(amountStr);

      const tx = await contract.withdrawBNB(to, amountWei);
      setMessage(msgBox, "success", "æç° BNB äº¤æ˜“å·²å‘é€ï¼Œç­‰å¾…ç¡®è®¤ä¸­...\nTX: " + tx.hash);
      await tx.wait();
      setMessage(msgBox, "success", "æç° BNB å·²ç¡®è®¤ âœ…\nTX: " + tx.hash);
      await refreshContractStatus();
    } catch (err) {
      console.error(err);
      setMessage(msgBox, "error", "æç°å¤±è´¥ï¼š\n" + (err.data?.message || err.message || err));
    }
  });

  // ===== æŸ¥è¯¢ Token ä½™é¢ =====
  document.getElementById("withdraw-token-check").addEventListener("click", async () => {
    const msgBox = document.getElementById("withdraw-msg");
    setMessage(msgBox, "", "");
    try {
      if (!provider) throw new Error("è¯·å…ˆè¿æ¥ MetaMaskã€‚");
      const tokenAddr = document.getElementById("withdraw-token-token").value.trim();
      if (!tokenAddr) throw new Error("è¯·å¡«å†™ Token åœ°å€ã€‚");
      const decimals = await getTokenDecimals(tokenAddr);
      const bal = await getTokenBalance(tokenAddr);
      const balFormatted = ethers.utils.formatUnits(bal, decimals);
      setMessage(
        msgBox,
        "success",
        "åˆçº¦æŒæœ‰è¯¥ Token ä½™é¢çº¦ä¸ºï¼š\n" + balFormatted + "ï¼ˆæŒ‰ decimals = " + decimals + " æ ¼å¼åŒ–ï¼‰"
      );
    } catch (err) {
      console.error(err);
      setMessage(msgBox, "error", "æŸ¥è¯¢å¤±è´¥ï¼š\n" + (err.data?.message || err.message || err));
    }
  });

  // ===== æç° Token =====
  document.getElementById("withdraw-token-submit").addEventListener("click", async () => {
    const msgBox = document.getElementById("withdraw-msg");
    setMessage(msgBox, "", "");
    try {
      if (!contract) throw new Error("è¯·å…ˆè¿æ¥ MetaMaskã€‚");
      const tokenAddr = document.getElementById("withdraw-token-token").value.trim();
      const to = document.getElementById("withdraw-token-to").value.trim();
      const amountStr = document.getElementById("withdraw-token-amount").value.trim();

      if (!tokenAddr || !to || !amountStr) {
        throw new Error("è¯·å¡«å†™ Token åœ°å€ã€æ¥æ”¶åœ°å€å’Œæç°æ•°é‡ã€‚");
      }

      const decimals = await getTokenDecimals(tokenAddr);
      const amount = ethers.utils.parseUnits(amountStr, decimals);

      const tx = await contract.withdrawToken(tokenAddr, to, amount);
      setMessage(msgBox, "success", "æç° Token äº¤æ˜“å·²å‘é€ï¼Œç­‰å¾…ç¡®è®¤ä¸­...\nTX: " + tx.hash);
      await tx.wait();
      setMessage(msgBox, "success", "æç° Token å·²ç¡®è®¤ âœ…\nTX: " + tx.hash);
    } catch (err) {
      console.error(err);
      setMessage(msgBox, "error", "æç°å¤±è´¥ï¼š\n" + (err.data?.message || err.message || err));
    }
  });

</script>
</body>
</html>
